---
import { getDisplayName, getProfileLink } from "../../lib/user";
import Avatar from "../users/Avatar.astro";

const { post, currentUserId } = Astro.props;

function getTimeAgo(date: string): string {
  const seconds = Math.floor(
    (new Date().getTime() - new Date(date).getTime()) / 1000,
  );

  const intervals = {
    year: 31536000,
    month: 2592000,
    week: 604800,
    day: 86400,
    hour: 3600,
    minute: 60,
  };

  for (const [unit, secondsInUnit] of Object.entries(intervals)) {
    const interval = Math.floor(seconds / secondsInUnit);
    if (interval >= 1) {
      return `${interval} ${unit}${interval > 1 ? "s" : ""} ago`;
    }
  }

  return "just now";
}
---

<div class="rounded-lg shadow-sm border p-6">
  <div class="flex gap-4">
    <a href={getProfileLink(post.profiles)}>
      <Avatar user={post.profiles} />
    </a>

    <div class="flex-1 min-w-0">
      <div class="flex items-center gap-2">
        <a
          href={getProfileLink(post.profiles)}
          class="font-semibold hover:underline"
        >
          {getDisplayName(post.profiles)}
        </a>
        <span class="text-[var(--subtext)]">Â·</span>
        <span class="text-sm text-[var(--subtext)]">
          {getTimeAgo(post.created_at)}
        </span>
      </div>

      <p class="mt-2 text-[var(--subtext)] whitespace-pre-wrap">
        {post.content}
      </p>

      <div class="mt-4 flex items-center gap-6">
        <form action="/api/posts/like" method="POST" class="inline">
          <input type="hidden" name="postId" value={post.id} />
          <button
            type="submit"
            class="flex items-center gap-2 text-gray-500 hover:text-red-600 transition-colors"
          >
            <span class={post.is_liked ? "text-red-600" : ""}>
              {post.is_liked ? "â¤ï¸" : "ğŸ¤"}
            </span>
            <span class="text-sm">{post.likes_count || 0}</span>
          </button>
        </form>

        <a
          href={`/post/${post.id}`}
          class="flex items-center gap-2 text-gray-500 hover:text-[var(--accent)] transition-colors"
        >
          <span>ğŸ’¬</span>
          <span class="text-sm">{post.comments_count || 0}</span>
        </a>
      </div>
    </div>
  </div>
</div>
