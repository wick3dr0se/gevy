---
interface Props {
  triggerClass: string;
  popoverClass: string;
  closeOthers?: boolean;
  closeOthersSelector?: string;
}

const {
  triggerClass,
  popoverClass,
  closeOthers = false,
  closeOthersSelector = "",
} = Astro.props;

const uniqueId = `popover-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="popover-wrapper relative inline-block" data-popover-id={uniqueId}>
  <slot name="trigger" />
  <slot name="content" />
</div>

<script
  define:vars={{
    uniqueId,
    triggerClass,
    popoverClass,
    closeOthers,
    closeOthersSelector,
  }}
>
  document.addEventListener("DOMContentLoaded", () => {
    const wrapper = document.querySelector(`[data-popover-id="${uniqueId}"]`);
    if (!wrapper) return;

    const trigger = wrapper.querySelector(`.${triggerClass}`);
    const popover = wrapper.querySelector(`.${popoverClass}`);

    if (!trigger || !popover) return;

    let timeout = null;

    const showPopover = () => {
      if (timeout) clearTimeout(timeout);

      if (closeOthers && closeOthersSelector) {
        document
          .querySelectorAll(closeOthersSelector)
          .forEach((p) => p.classList.add("hidden"));
      }

      popover.classList.remove("hidden");
      popover.dispatchEvent(new CustomEvent("popover:show"));
    };

    const hidePopover = () => {
      timeout = setTimeout(() => popover.classList.add("hidden"), 150);
    };

    trigger.addEventListener("mouseenter", showPopover);
    trigger.addEventListener("mouseleave", hidePopover);
    popover.addEventListener("mouseenter", showPopover);
    popover.addEventListener("mouseleave", hidePopover);

    trigger.addEventListener("click", () => {
      const isHidden = popover.classList.contains("hidden");
      if (closeOthers && closeOthersSelector) {
        document
          .querySelectorAll(closeOthersSelector)
          .forEach((p) => p.classList.add("hidden"));
      }
      if (isHidden) showPopover();
      else hidePopover();
    });
  });
</script>
