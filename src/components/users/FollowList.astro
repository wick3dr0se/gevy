---
import Popover from "../Popover.astro";

interface Props {
  userId: string;
  type: "followers" | "following";
  count: number;
}

const { userId, type, count } = Astro.props;
---

<Popover
  triggerClass="followers-trigger"
  popoverClass="followers-popover"
  closeOthers={true}
  closeOthersSelector=".followers-popover"
>
  <span
    slot="trigger"
    class="followers-trigger underline cursor-pointer hover:text-[var(--accent)]"
  >
    {count}
    <span class="text-[var(--subtext)]">{type}</span>
  </span>

  <div
    slot="content"
    class="followers-popover absolute left-0 mt-2 w-80 max-h-96 overflow-y-auto border rounded-lg shadow-lg bg-[var(--bg)] hidden z-10"
    data-user-id={userId}
    data-type={type}
  >
    <div class="followers-list p-3 text-center text-[var(--subtext)]">
      Loading...
    </div>
  </div>
</Popover>

<script>
  import {
    getAvatarUrl,
    getDisplayName,
    getProfileHandle,
    getProfileLink,
  } from "../../lib/queries/user";

  type User = {
    display_name?: string | null;
    username?: string | null;
    github_username?: string | null;
    avatar_url?: string | null;
    github_avatar_url?: string | null;
  };

  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".followers-popover").forEach((popover) => {
      if (!(popover instanceof HTMLElement)) return;

      const list = popover.querySelector(".followers-list");
      if (!list) return;

      let fetched = false;

      popover.addEventListener("popover:show", () => {
        if (fetched) return;
        fetched = true;

        fetch(`/api/users/${popover.dataset.userId}/${popover.dataset.type}`)
          .then((r) => r.json())
          .then((data: { users?: User[] }) => {
            const users = data.users || [];
            if (!users.length) {
              list.innerHTML = `<div class="py-4 text-[var(--subtext)]">No ${popover.dataset.type} yet</div>`;
              return;
            }
            list.innerHTML = users
              .map((u: User) => {
                const displayName = getDisplayName(u);
                return `
                  <a href="${getProfileLink(u)}"
                     class="flex items-center gap-3 p-2 rounded-lg hover:bg-[var(--muted)] transition">
                    <img src="${getAvatarUrl(u)}"
                         alt="${displayName}"
                         class="w-10 h-10 rounded-full" />
                    <div class="flex-1 min-w-0">
                      <p class="font-semibold text-[var(--text)] truncate">${displayName}</p>
                      <p class="text-sm text-[var(--subtext)] truncate">${getProfileHandle(u)}</p>
                    </div>
                  </a>
                `;
              })
              .join("");
          })
          .catch(() => {
            list.innerHTML = `<div class="text-[var(--danger)] py-4">Failed to load</div>`;
          });
      });
    });
  });
</script>
