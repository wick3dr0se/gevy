---
import Avatar from "./Avatar.astro";

interface Props {
  profile: any;
  isFollowing: boolean;
}

const { profile, isFollowing } = Astro.props;
---

<div class="rounded-lg shadow-sm border p-6">
  <div class="flex items-start gap-4">
    <Avatar
      user={{
        username: profile.username,
        github_username: profile.github_username,
        github_avatar_url: profile.github_avatar_url,
        avatar_url: profile.avatar_url,
      }}
    />
    <div class="flex-1 min-w-0">
      <a
        href={`/profile/${profile.username}`}
        class="font-semibold hover:underline block truncate"
      >
        {profile.username || profile.github_username}
      </a>
      <p class="text-sm text-[var(--subtext)] truncate">
        @{profile.github_username || profile.username}
      </p>

      {
        profile.bio && (
          <p class="text-sm text-[var(--subtext)] mt-2 line-clamp-2">
            {profile.bio}
          </p>
        )
      }

      <div class="mt-3 flex gap-4 text-xs text-[var(--subtext)]">
        <span>{profile.followers_count} followers</span>
      </div>

      <button
        class="follow-btn mt-4 w-full px-4 py-2 rounded-lg transition-colors font-medium text-sm"
        data-following-id={profile.id}
        data-is-following={isFollowing}
      >
        {isFollowing ? "Following" : "Follow"}
      </button>
    </div>
  </div>

  <script>
    document.querySelectorAll(".follow-btn").forEach((btn) => {
      const isFollowing = btn.getAttribute("data-is-following") === "true";

      if (isFollowing) {
        btn.classList.add("bg-gray-200", "text-gray-700", "hover:bg-gray-300");
      } else {
        btn.classList.add("bg-blue-600", "text-white", "hover:bg-blue-700");
      }

      btn.addEventListener("click", async (e) => {
        const target = e.target as HTMLButtonElement;
        const followingId = target.getAttribute("data-following-id");

        try {
          const response = await fetch("/api/follow", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ followingId }),
          });

          const data = await response.json();

          target.setAttribute("data-is-following", String(data.isFollowing));
          target.textContent = data.isFollowing ? "Following" : "Follow";

          if (data.isFollowing) {
            target.classList.remove(
              "bg-blue-600",
              "text-white",
              "hover:bg-blue-700",
            );
            target.classList.add(
              "bg-gray-200",
              "text-gray-700",
              "hover:bg-gray-300",
            );
          } else {
            target.classList.remove(
              "bg-gray-200",
              "text-gray-700",
              "hover:bg-gray-300",
            );
            target.classList.add(
              "bg-blue-600",
              "text-white",
              "hover:bg-blue-700",
            );
          }
        } catch (error) {
          console.error("Follow error:", error);
        }
      });
    });
  </script>
</div>
