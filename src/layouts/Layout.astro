---
interface Props {
  title: string;
}

const { title } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/logo.svg" />
    <title>{title}</title>
  </head>
  <body class="min-h-screen">
    <slot />
    <footer
      class="border-t py-6 mt-12 text-center text-sm text-[var(--subtext)] border-[var(--text)]"
    >
      <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between items-center gap-2"
      >
        <p>Â© {new Date().getFullYear()} Gevy</p>
        <a href="/privacy" class="hover:text-gray-900">Privacy</a>
      </div>
    </footer>
  </body>
</html>

<style is:global>
  @import "tailwindcss";

  @custom-variant dark (&:where(.dark, .dark *));

  :root {
    --bg: #f6f3e7;
    --surface: theme(colors.white);
    --text: theme(colors.gray.900);
    --subtext: theme(colors.gray.700);
    --border: theme(colors.gray.300);

    --accent: theme(colors.blue.600);
    --accent-hover: theme(colors.blue.700);
    --accent-faint: theme(colors.blue.100);
    --muted: theme(colors.gray.100);

    --danger: theme(colors.red.600);
    --success: theme(colors.green.600);
    --warning: theme(colors.amber.500);
  }

  .dark {
    --bg: #232329;
    --surface: theme(colors.gray.900);
    --text: theme(colors.gray.100);
    --subtext: theme(colors.gray.400);
    --border: theme(colors.gray.700);

    --accent: theme(colors.blue.400);
    --accent-hover: theme(colors.blue.300);
    --accent-faint: theme(colors.blue.950);
    --muted: theme(colors.gray.800);

    --danger: theme(colors.red.500);
    --success: theme(colors.green.500);
    --warning: theme(colors.amber.400);
  }

  body,
  header {
    @apply bg-[var(--bg)] text-[var(--text)];
  }

  hr,
  .border {
    @apply border-[var(--border)];
  }
</style>

<script>
  const step = 15;
  const initialDelay = 300; // Match browser's initial delay (~300ms)

  type KeyName = "w" | "a" | "s" | "d" | "h" | "j" | "k" | "l";

  const keys: Record<KeyName, boolean> = {
    w: false,
    a: false,
    s: false,
    d: false,
    h: false,
    j: false,
    k: false,
    l: false,
  };

  let animationFrameId: number | null = null;
  let delayTimeoutId: number | null = null;
  let isInitialPress = false;

  function scrollPage() {
    let x = 0,
      y = 0;
    if (keys.w || keys.k) y -= step;
    if (keys.s || keys.j) y += step;
    if (keys.a || keys.h) x -= step;
    if (keys.d || keys.l) x += step;

    if (x || y) {
      window.scrollBy({
        top: y,
        left: x,
        behavior: "instant",
      });
    }
  }

  function animate() {
    scrollPage();

    const anyKeyPressed = Object.values(keys).some((pressed) => pressed);

    if (anyKeyPressed) {
      animationFrameId = requestAnimationFrame(animate);
    } else {
      animationFrameId = null;
    }
  }

  function startScrolling() {
    if (animationFrameId === null) {
      animate();
    }
  }

  window.addEventListener("keydown", (e: KeyboardEvent) => {
    const tag = (document.activeElement as HTMLElement)?.tagName;
    if (
      tag === "INPUT" ||
      tag === "TEXTAREA" ||
      (document.activeElement as HTMLElement)?.isContentEditable
    )
      return;

    const key = e.key.toLowerCase();
    if (!(key in keys)) return;

    const typedKey = key as KeyName;

    if (!keys[typedKey]) {
      keys[typedKey] = true;
      isInitialPress = true;

      // Bounce
      scrollPage();

      // Wait before continuous scrolling starts
      if (delayTimeoutId !== null) {
        clearTimeout(delayTimeoutId);
      }

      delayTimeoutId = window.setTimeout(() => {
        isInitialPress = false;
        startScrolling();
        delayTimeoutId = null;
      }, initialDelay);
    }

    e.preventDefault();
  });

  window.addEventListener("keyup", (e: KeyboardEvent) => {
    const key = e.key.toLowerCase();
    if (key in keys) {
      const typedKey = key as KeyName;
      keys[typedKey] = false;

      // Clear the delay timer if key is released during initial delay
      if (delayTimeoutId !== null) {
        clearTimeout(delayTimeoutId);
        delayTimeoutId = null;
      }

      e.preventDefault();
    }
  });
</script>
