---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import CreatePost from "../components/CreatePost.astro";
import PostCard from "../components/PostCard.astro";
import { createServerSupabaseClient } from "../lib/supabase";

const supabase = createServerSupabaseClient(Astro.cookies);
const {
    data: { session },
} = await supabase.auth.getSession();

if (!session) {
    return Astro.redirect("/");
}

// Get user profile
const { data: profile } = await supabase
    .from("profiles")
    .select("*")
    .eq("id", session.user.id)
    .single();

if (!profile) {
    return Astro.redirect("/");
}

// Get recent posts from followed users (and own posts)
const { data: following } = await supabase
    .from("follows")
    .select("following_id")
    .eq("follower_id", session.user.id);

const followingIds = following?.map((f) => f.following_id) || [];
followingIds.push(session.user.id); // Include own posts

const { data: posts } = await supabase
    .from("posts")
    .select(
        `
    *,
    profiles (*)
  `,
    )
    .in("author_id", followingIds)
    .order("created_at", { ascending: false })
    .limit(20);

// Get likes count and check if user liked each post
const postsWithMeta = await Promise.all(
    (posts || []).map(async (post) => {
        const { count: likesCount } = await supabase
            .from("post_likes")
            .select("*", { count: "exact", head: true })
            .eq("post_id", post.id);

        const { data: userLike } = await supabase
            .from("post_likes")
            .select("id")
            .eq("post_id", post.id)
            .eq("user_id", session.user.id)
            .single();

        const { count: commentsCount } = await supabase
            .from("comments")
            .select("*", { count: "exact", head: true })
            .eq("post_id", post.id);

        return {
            ...post,
            likes_count: likesCount || 0,
            comments_count: commentsCount || 0,
            is_liked: !!userLike,
        };
    }),
);
---

<Layout title="Dashboard - Gevy">
    <Header user={profile} />

    <main class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="space-y-6">
            <CreatePost user={profile} />

            {
                postsWithMeta.length === 0 ? (
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-12 text-center">
                        <p class="text-gray-600 mb-4">
                            No posts yet. Start by following some developers or
                            create your first post!
                        </p>
                        <a
                            href="/discover"
                            class="inline-block px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                        >
                            Discover Developers
                        </a>
                    </div>
                ) : (
                    postsWithMeta.map((post) => (
                        <PostCard post={post} currentUserId={session.user.id} />
                    ))
                )
            }
        </div>
    </main>
</Layout>
