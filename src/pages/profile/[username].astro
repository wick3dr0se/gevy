---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import PostCard from "../../components/posts/PostCard.astro";
import ProfileCard from "../../components/users/profile/ProfileCard.astro";
import { createServerSupabaseClient } from "../../lib/supabase";
import { getProfileWithSync } from "../../lib/queries/profile";
import { getPostsWithMetadata } from "../../lib/queries/posts";
import { getDisplayName } from "../../lib/queries/user";

Astro.response.headers.set(
  "Cache-Control",
  "public, s-maxage=120, stale-while-revalidate=600",
);

const supabase = createServerSupabaseClient(Astro.cookies);
const {
  data: { session },
} = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect("/");
}

const { username } = Astro.params as { username: string };

const { data: currentUserProfile } = await supabase
  .from("profiles")
  .select("*")
  .eq("id", session.user.id)
  .single();

const profile = await getProfileWithSync(
  supabase,
  username,
  session.provider_token ?? undefined,
);

if (!profile) {
  return Astro.redirect("/dashboard");
}

const isOwnProfile = profile.id === session.user.id;

// Check if following
const { data: followData } = await supabase
  .from("follows")
  .select("id")
  .eq("follower_id", session.user.id)
  .eq("following_id", profile.id)
  .single();

const isFollowing = !!followData;

// Get posts with metadata
const postsWithMeta = await getPostsWithMetadata(
  supabase,
  profile.id,
  session.user.id,
);
---

<Layout title={`${getDisplayName(profile)} - Gevy`}>
  <Header user={currentUserProfile} />

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <div class="lg:col-span-2 space-y-8">
        <ProfileCard
          profile={profile}
          isOwnProfile={isOwnProfile}
          isFollowing={isFollowing}
        />

        <!-- Posts -->
        <div class="space-y-6">
          <h2 class="text-xl font-semibold">Posts</h2>
          {
            postsWithMeta.length === 0 ? (
              <div class="rounded-lg shadow-sm border p-12 text-center text-[var(--subtext)]">
                No posts yet.
              </div>
            ) : (
              postsWithMeta.map((post: any) => (
                <PostCard post={post} currentUserId={session.user.id} />
              ))
            )
          }
        </div>
      </div>

      <div class="lg:col-span-1">
        <div class="rounded-lg shadow-sm border p-6">
          <a
            href="/dashboard"
            class="inline-flex items-center gap-2 text-[var(--subtext)] hover:text-[var(--text)]"
          >
            ‚Üê Back to Dashboard
          </a>
        </div>
      </div>
    </div>
  </main>
</Layout>
