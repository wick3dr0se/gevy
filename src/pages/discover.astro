---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import UserCard from "../components/users/UserCard.astro";
import { createServerSupabaseClient } from "../lib/supabase";

const supabase = createServerSupabaseClient(Astro.cookies);
const {
  data: { session },
} = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect("/");
}

const { data: currentUserProfile } = await supabase
  .from("profiles")
  .select("*")
  .eq("id", session.user.id)
  .single();

// Get all profiles except current user
const { data: profiles } = await supabase
  .from("profiles")
  .select("*")
  .neq("id", session.user.id)
  .order("created_at", { ascending: false })
  .limit(50);

// Check which users the current user is following
const { data: following } = await supabase
  .from("follows")
  .select("following_id")
  .eq("follower_id", session.user.id);

const followingIds = new Set(following?.map((f) => f.following_id) || []);
---

<Layout title="Discover - Gevy">
  <Header user={currentUserProfile} />

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-2xl font-bold text-[var(--text)] mb-6">
      Discover Developers
    </h1>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {
        profiles?.map((profile) => (
          <UserCard
            profile={profile}
            isFollowing={followingIds.has(profile.id)}
          />
        ))
      }
    </div>
  </main>
</Layout>
